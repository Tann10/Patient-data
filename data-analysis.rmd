---
title: "Patient data analysis"
author: "Tanaya Kavathekar"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: hide
    fig_height: 4.5
    fig_width: 7
    highlight: tango
    number_sections: yes
    theme: cosmo
    toc: yes
    toc_float: true
  pdf_document:
    toc: yes
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(error = F)
#knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(include = T)
knitr::opts_chunk$set(warning = F)
```

```{r basicfcn, include=F}
# can add quietly=T option to the require() function
loadPkg = function(x) { if (!require(x,character.only=T, quietly =T)) { install.packages(x,dep=T,repos="http://cran.us.r-project.org"); if(!require(x,character.only=T)) stop("Package not found") } }


# Create the function.
getmode <- function(v) {
   uniqv <- unique(v)
   uniqv[which.max(tabulate(match(v, uniqv)))]
}

```

```{r, include=F}
loadPkg("readxl")
loadPkg("plyr")
loadPkg("dplyr")
loadPkg("stringr")
loadPkg("tidyverse")
loadPkg("ggplot2")
loadPkg("plotly")
loadPkg("lubridate")

```

Reading data ..
```{r}
raw_df <- read.csv("processed_df.csv")
names(raw_df) <- str_replace_all(names(raw_df), c(" " = "_"))

dim(raw_df)
length(unique(raw_df$Dim_Patient))
```


Roll up the data at a day level and remove observations less than 3 days
```{r}
day_level<- processed_df %>% group_by(Dim_Patient, trimester, Observation_Source, date, week, days) %>% summarise(wt_avg = mean(Observation_Value))

gtr_3 <- day_level %>% group_by(Dim_Patient) %>% count() %>% filter(n > 2)

day_level <- day_level %>% filter(Dim_Patient %in% gtr_3$Dim_Patient)

length(unique(day_level$Dim_Patient))
dim(day_level)

hist(gtr_3$n)
```

Roll up the data at a day level and remove observations less than 2 week
```{r}
week_level<- processed_df %>% group_by(Dim_Patient, trimester, Observation_Source, week) %>% summarise(wt_avg = mean(Observation_Value))

gtr_1 <- week_level %>% group_by(Dim_Patient) %>% count() %>% filter(n>1)

week_level <- week_level %>% filter(!Dim_Patient %in% gtr_1$Dim_Patient)

length(unique(week_level$Dim_Patient))
dim(week_level)
# remove if weeks 2 and week diff less than 8

hist(gtr_1$n)
```

Check first and last week difference in weights
```{r}

initial_wt <- day_level %>% group_by(Dim_Patient) %>% 
  arrange(Dim_Patient, date) %>% filter(row_number()==1 | row_number()==n()) %>%  arrange(Dim_Patient, date) %>% mutate(weight_diff_tri = c(0,diff(wt_avg)), week_diff = c(0,diff(week)))


```


Merge Age, height and calculate BMI
```{r}
ht <- read_excel('GWG(2+)_Corrected.5.10.20(lowcount).xlsx', sheet ='demographics')
names(ht) <- str_replace_all(names(ht), c(" " = "_"))

day_level_demo <- merge(day_level, ht[,c("Dim_Patient", "Activated_At",
                                         "Date_of_Birth", "Age_at_Activation_(years)", 
                                         "Customer_Group", "Height_(m)")],
                        by= "Dim_Patient", all.x = TRUE)


day_level_demo$weight_kg <- day_level_demo$wt_avg/2.2046
```

Calculate BMI 
```{r}
init_wt <-day_level_demo %>% group_by(Dim_Patient) %>% arrange(Dim_Patient,date) %>% filter(row_number() == 1)
  
# initial weight bmi
init_wt$bmi <- init_wt$weight_kg/(init_wt$`Height_(m)`^2)

day_level_demo <- merge(day_level_demo, init_wt[, c("Dim_Patient", "bmi")], by = "Dim_Patient", all.x = T)


day_level_demo$bmi_category <- ifelse(day_level_demo$bmi <25, "25&less", 
                                      ifelse(day_level_demo$bmi<30, "between25&30",
                                             ifelse(day_level_demo$bmi<35, "between30&35", 
                                                    ifelse(day_level_demo$bmi<40,"between35&40",
                                                           ifelse(day_level_demo$bmi<60,"between40&59",
                                                           "over60")))))

# check patient having ht less than 0.5

lessht <- day_level_demo %>% filter(`Height_(m)`<0.6)
length(unique(lessht))
```
```{r}
# check T3 drop  wt diff if < -9

```
##1) How many total patients by: 
###       - Practice group 
       - Age bracket (5 years)
       - BMI category (less than 25 ; 25.1 - 29.9 ; 30-34.9 ; 35.0-39.9 ; 40-59.9 ; 60 -over)
       
```{r}
# By practice group
q1_groups <- day_level_demo %>% select(Customer_Group, Dim_Patient) %>% unique() %>% 
            group_by(Customer_Group) %>% count() %>% arrange(n)

q1_groups$Customer_Group <- factor(q1_groups$Customer_Group, levels = unique(q1_groups$Customer_Group))

#plot_ly(q1_groups, y = ~q1_groups$Customer_Group, x = ~q1_groups$n, type = 'bar',  orientation = 'h')

plt1 <- ggplot(q1_groups, aes(x =Customer_Group,  y =n)) + 
  geom_bar(stat = "identity", fill = 'blue') + #theme(axis.text.x = element_text(angle = 90)) +
  theme(axis.title.x=element_blank(), axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) + 
  ggtitle("Total patients across patient groups") +
  ylab("Count of Patients") +
  xlab("Patient groups")



ggplotly(plt1)

```

### Age
```{r}
# Age bracket 
age <- day_level_demo %>% filter((`Age_at_Activation_(years)`>14) &
                                   (`Age_at_Activation_(years)`<60))

length(unique(day_level_demo$Dim_Patient)) - length(unique(age$Dim_Patient))

age$age_category <- ifelse(age$`Age_at_Activation_(years)`<20, "14-19", 
                                      ifelse(age$`Age_at_Activation_(years)`<25, "20-24",
                                             ifelse(age$`Age_at_Activation_(years)`<30, "25-29", 
                                                  ifelse(age$`Age_at_Activation_(years)`<35,"30-34",
                                                        ifelse(age$`Age_at_Activation_(years)`<40,"35-39",
                                                               ifelse(age$`Age_at_Activation_(years)`<45,"40-44",
                                                                      ifelse(age$`Age_at_Activation_(years)`<50,"45-49",
                                                                             ifelse(age$`Age_at_Activation_(years)`<55,"50-54", "55-60"))))))))                          



#age$age_category <- as.numeric(cut(age$`Age_at_Activation_(years)`, 9))
q1_age <- age %>% select(Dim_Patient, age_category) %>% unique() %>% group_by(age_category) %>% count() 

plt1 <- ggplot(q1_age, aes(x =age_category,  y =n)) + 
  geom_bar(stat = "identity", fill='darkblue') +
  ggtitle("Total patients across different age groups") +
  ylab("Count of Patients") +
  xlab("Age Categories")

ggplotly(plt1)


```


### BMI Categories

```{r}
bmi <- day_level_demo %>% filter((!is.na(bmi_category)) & (`Height_(m)` >0.5))
q1_bmi <- bmi %>% select(Dim_Patient, bmi_category) %>% unique() %>%group_by(bmi_category) %>% count() 

plt1 <- ggplot(q1_bmi, aes(x =bmi_category,  y =n)) + 
  geom_bar(stat = "identity", fill='darkblue') +
  ggtitle("Total patients across different BMI groups") +
  ylab("Count of Patients") +
  xlab("BMI Categories")

ggplotly(plt1)

```


2) How often did each patient enter weights by: 
        - Entire population 
         - Practice group 
       - Age bracket (5 years)
       - BMI category (less than 25 ; 25.1 - 29.9 ; 30-34.9 ; 35.0-39.9 ; 40-59.9 ; 60 -over)
       
       
```{r}
q2_whole <- day_level_demo %>% group_by(Dim_Patient) %>% count()
summary(q2_whole)
hist(q2_whole$n)
q2_prac <- day_level_demo %>% group_by(Customer_Group, Dim_Patient) %>% summarise(count = n()) %>% 
  ungroup() %>% group_by(Customer_Group) %>% summarise(avg_count = mean(count),
                                                                  std_count = sd(count)) 
                                                                  

q2_age <- age %>% group_by(age_category, Dim_Patient) %>% summarise(count = n()) %>% ungroup() %>% group_by(age_category) %>% summarise(avg_count = mean(count),std_count = sd(count)) 


q2_bmi <- bmi %>% group_by(bmi_category, Dim_Patient) %>% summarise(count = n()) %>% ungroup() %>% group_by(bmi_category) %>% summarise(avg_count = mean(count),std_count = sd(count)) 

```

3) What is the average starting time (I.e Gestational age at first entry ) By: 
    --same as previous 

```{r}
# do this for week

q3_whole <- day_level_demo %>% group_by(Dim_Patient) %>% summarise(start_date = min(date))

q3_prac <- day_level_demo %>% group_by(Customer_Group, Dim_Patient) %>% 
  summarise(start_date = min(date)) %>% ungroup() %>% group_by(Customer_Group) %>%
  summarise(mean_date = mean.Date(start_date))

q3_age <- age %>% group_by(age_category, Dim_Patient) %>% 
  summarise(start_date = min(date)) %>% ungroup() %>% group_by(age_category) %>%
  summarise(mean_date = mean.Date(start_date))

plot1 <- ggplot(data=q3_age, aes(y=mean_date, x=age_category)) +
  geom_line()+
  geom_point() +
  ggtitle("Average starting time with ") 

ggplotly(plot1)


q3_bmi <- bmi %>% group_by(bmi_category, Dim_Patient) %>% 
  summarise(start_date = min(date)) %>% ungroup() %>% group_by(bmi_category) %>%
  summarise(mean_date = mean.Date(start_date))
```

4) What is the  length of involvement (i.e difference of gestational age) By: 
    -- same as previous 
    
```{r}
q4_whole <- day_level_demo %>% group_by(Dim_Patient) %>% summarise(start_date = min(date), end_date = max(date),  length = end_date - start_date) 
q4_whole$length2 = as.numeric(q4_whole$length)
g1 <- ggplot(q4_whole, aes(x=length2)) +geom_histogram()
ht1 <- hist(q4_whole$length2)
ggplotly(g1)

q4_prac <- day_level_demo %>% group_by(Customer_Group, Dim_Patient) %>% 
  summarise(start_date = min(date), end_date = max(date),  length = end_date - start_date) %>% 
  ungroup() %>% group_by(Customer_Group) %>%
  summarise(avg_length = mean(length)) %>% arrange(avg_length)

q4_prac$Customer_Group <- factor(q4_prac$Customer_Group, levels = unique(q4_prac$Customer_Group))

plt1 <- ggplot(q4_prac, aes(x =Customer_Group,  y =avg_length)) + 
  geom_bar(stat = "identity", fill = 'blue') + #theme(axis.text.x = element_text(angle = 90)) +
  theme(axis.title.x=element_blank(), axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) + 
  ggtitle("Total patients across patient groups") +
  ylab("Count of Patients") +
  xlab("Patient groups")

ggplotly(plt1)

q4_age <- age %>% group_by(age_category, Dim_Patient) %>% 
  summarise(start_date = min(date), end_date = max(date),  length = end_date - start_date) %>% 
  ungroup() %>% group_by(age_category) %>%
  summarise(mean_date = mean(length))


q4_bmi <- bmi %>% group_by(bmi_category, Dim_Patient) %>% 
  summarise(start_date = min(date), end_date = max(date),  length = end_date - start_date) %>% 
  ungroup() %>% group_by(bmi_category) %>%
  summarise(mean_date = mean(length))

```

5) Weight difference at the start - finish of each trimester by (may be hard for people with only 1 entry per trimester): 
      - Whole group 
      - Practice group
      - Age 
     - BMI group 
     
```{r}
q5_whole <- day_level_demo %>% group_by(Dim_Patient, trimester)  %>% 
  arrange(Dim_Patient, date) %>% filter(row_number()==1 | row_number()==n()) %>% 
  mutate(n = n()) %>%
  filter(n>1) %>%
  summarise(weight_diff = diff(wt_avg))

g1 <- ggplot(q5_whole, aes(x=weight_diff)) + geom_histogram()
ggplotly(g1)


q5_prac <- day_level_demo %>% group_by(Customer_Group, Dim_Patient, trimester)  %>% 
 arrange(Customer_Group, Dim_Patient, date) %>% filter(row_number()==1 | row_number()==n()) %>% 
  mutate(n = n()) %>%
  filter(n>1) %>%
  summarise(weight_diff = diff(wt_avg)) %>% ungroup() %>%
  group_by(Customer_Group, trimester) %>% summarise(avg_weight_diff = mean(weight_diff), 
                                                    std_wt_diff = sd(weight_diff))


q5_age <- age %>% group_by(age_category, Dim_Patient, trimester)  %>% 
 arrange(Dim_Patient, date) %>% filter(row_number()==1 | row_number()==n()) %>% 
  mutate(n = n()) %>%
  filter(n>1) %>%
  summarise(weight_diff = diff(wt_avg)) %>% ungroup() %>%
  group_by(age_category, trimester) %>% summarise(avg_weight_diff = mean(weight_diff), 
                                                    std_wt_diff = sd(weight_diff))


q5_bmi <- bmi %>% group_by(bmi_category, Dim_Patient, trimester)  %>% 
 arrange(Dim_Patient, date) %>% filter(row_number()==1 | row_number()==n()) %>% 
  mutate(n = n()) %>%
  filter(n>1) %>%
  summarise(weight_diff = diff(wt_avg)) %>% ungroup() %>%
  group_by(bmi_category, trimester) %>% summarise(avg_weight_diff = mean(weight_diff), 
                                                    std_wt_diff = sd(weight_diff))

```

6) weight difference from the first observation to the last observation (IN TRIMESTER 3) 
    by: 
      - same as above 
      
      
```{r}
q6_whole <- q5_whole %>% filter(trimester == "T3")
g1 <- ggplot(q6_whole, aes(x=weight_diff)) + geom_histogram()
ggplotly(g1)
q6_prac <- q5_prac %>% filter(trimester == "T3")
q6_age <- q5_age %>% filter(trimester == "T3")
q6_bmi <- q5_bmi %>% filter(trimester == "T3")
```

7) Weight difference from last entry in T3 to last entry in PP by: 
     - same as above 
     
```{r}

q7_whole <- day_level_demo %>% filter(trimester %in% c("T3", "PP")) %>% 
  group_by(Dim_Patient, trimester)  %>% 
  arrange(Dim_Patient,date) %>% 
  filter(row_number()==n()) %>% ungroup() %>%  
  group_by(Dim_Patient) %>%
  mutate(n = n()) %>%
  filter(n>1) %>%
  summarise(weight_diff = diff(wt_avg))

view(processed_df %>% filter(Dim_Patient == "ref:Patient/BabyscriptsLegacy#3273"))

g1 <- ggplot(q7_whole, aes(x=weight_diff)) + geom_histogram()
ggplotly(g1)

q7_prac <- day_level_demo %>% filter(trimester %in% c("T3", "PP")) %>% 
  group_by(Customer_Group, Dim_Patient, trimester)  %>% 
  arrange(Dim_Patient,date) %>% 
  filter(row_number()==n()) %>% ungroup() %>%  
  group_by(Dim_Patient) %>%
  mutate(n = n()) %>%
  filter(n>1) %>%
  mutate(weight_diff = diff(wt_avg)) %>% filter(row_number()==n()) %>% ungroup() %>%
  group_by(Customer_Group) %>%
  summarise(pt_count = n_distinct(Dim_Patient), avg_weight_diff = mean(weight_diff),
            std_wt_diff = sd(weight_diff))

q7_age <- age %>% filter(trimester %in% c("T3", "PP")) %>% 
  group_by(age_category, Dim_Patient, trimester)  %>% 
  arrange(Dim_Patient,date) %>% 
  filter(row_number()==n()) %>% ungroup() %>%  
  group_by(Dim_Patient) %>%
  mutate(n = n()) %>%
  filter(n>1) %>%
  mutate(weight_diff = diff(wt_avg)) %>% filter(row_number()==n()) %>% ungroup() %>%
  group_by(age_category) %>%
  summarise(pt_count = n_distinct(Dim_Patient), avg_weight_diff = mean(weight_diff),
            std_wt_diff = sd(weight_diff))

q7_bmi <- bmi %>% filter(trimester %in% c("T3", "PP")) %>% 
  group_by(Dim_Patient, trimester)  %>% 
  arrange(Dim_Patient,date) %>% 
  filter(row_number()==n()) %>% ungroup() %>%  
  group_by(Dim_Patient) %>%
  mutate(n = n()) %>%
  filter(n>1) %>%
  mutate(weight_diff = diff(wt_avg)) %>% filter(row_number()==n()) %>% ungroup() %>%
  group_by(bmi_category) %>%
  summarise(pt_count = n_distinct(Dim_Patient), avg_weight_diff = mean(weight_diff),
            std_wt_diff = sd(weight_diff))

```

## Check if weights difference are statistically significant

```{r}
# Run ANOVA
anova_wt_cg <- aov(wt_avg ~ Customer_Group, data = day_level_demo)
summary(anova_wt_cg)
anova_wt_cg
```


8) Can we get a rate of weight gain (T3-T1) for each group ; and rate of weight loss for PP (PP-T3) 
      - Perhaps here we can interpolate for PP (only 6 weeks)???? 

## What is the change in weight during pregnancy for our entire population (Initial entry to 40weeks gestation) 
```{r}
#q1 <-  out %>% group_by(week) %>% summarise(total_weight = sum(Observation_Value)) %>% arrange(week) %>% mutate(change = (c(total_weight[1], diff(total_weight)))/total_weight[1])

#plot1 <- ggplot(data=q1, aes(x=week, y=change)) +
#  geom_line()+
#  geom_point() +
#  ggtitle("Change in weight for all patients") 
  


#ggplotly(plot1)
```



## What is the change in weight for specific population groups (By customer group, by BMI category, by age) 


