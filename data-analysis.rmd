---
title: "Patient data analysis"
author: "Tanaya Kavathekar"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: hide
    fig_height: 4.5
    fig_width: 7
    highlight: tango
    number_sections: yes
    theme: cosmo
    toc: yes
    toc_float: true
  pdf_document:
    toc: yes
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(error = F)
#knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(include = T)
knitr::opts_chunk$set(warning = F)
```


```{r basicfcn, include=F}
# can add quietly=T option to the require() function
loadPkg = function(x) { if (!require(x,character.only=T, quietly =T)) { install.packages(x,dep=T,repos="http://cran.us.r-project.org"); if(!require(x,character.only=T)) stop("Package not found") } }

# load crosstab function
source("http://pcwww.liv.ac.uk/~william/R/crosstab.r")

# Create the function.
getmode <- function(v) {
   uniqv <- unique(v)
   uniqv[which.max(tabulate(match(v, uniqv)))]
}

```

```{r, include=F}
loadPkg("readxl")
loadPkg("plyr")
loadPkg("dplyr")
loadPkg("stringr")
loadPkg("tidyverse")
loadPkg("ggplot2")
loadPkg("plotly")
loadPkg("lubridate")
loadPkg("knitr")
loadPkg("epitools")
loadPkg("car")
```

Reading data ..
```{r}
raw_df <- read.csv("processed_df_5_19.csv")
names(raw_df) <- str_replace_all(names(raw_df), c(" " = "_"))
raw_df$date = as.Date(raw_df$date)

dim(raw_df)
length(unique(raw_df$Dim_Patient))
```



Roll up the data at a day level and remove observations less than 3 days
```{r}
day_level <- raw_df %>% 
  group_by(Dim_Patient, trimester, Observation_Source, date, week, days) %>% 
  summarise(wt_avg = mean(Observation_Value))

gtr_3 <- day_level %>% 
  group_by(Dim_Patient) %>% 
  count() %>% filter(n > 2)

day_level <- day_level %>% filter(Dim_Patient %in% gtr_3$Dim_Patient)

length(unique(day_level$Dim_Patient))
dim(day_level)

day_level <-day_level %>% group_by(Dim_Patient) %>%
  mutate( num_of_observ = n(),
    # engagement = ifelse(num_of_observ >6, "good", "bad")
    )


#write.csv(day_level, "day_level_5_19.csv")

g1 <- ggplot(gtr_3, aes(x=n)) + geom_histogram()
ggplotly(g1)
```

Total number of rows and columns are `r dim(day_level)` and total number of unique patients are `r length(unique(day_level$Dim_Patient))`


Roll up the data at a week level and remove observations just 1 week
```{r}
week_level<- raw_df %>% group_by(Dim_Patient, trimester, Observation_Source, week) %>% summarise(wt_avg = mean(Observation_Value))

gtr_1 <- week_level %>% group_by(Dim_Patient) %>% count() %>% filter(n>1)

week_level <- week_level %>% filter(Dim_Patient %in% gtr_1$Dim_Patient) 

week_level <-week_level %>% group_by(Dim_Patient) %>%
  mutate( num_of_observ = n(),
    engagement = ifelse(num_of_observ >6, "good", "bad"))

length(unique(week_level$Dim_Patient))
dim(week_level)

#write.csv(week_level, "week_level_5_19.csv")

# remove if weeks 2 and week diff less than 8

g1 <- ggplot(gtr_1, aes(x=n)) + geom_histogram()
ggplotly(g1)
```


Merge good list with patient at a day level
```{r}
good_list <- week_level %>% select(Dim_Patient, engagement) %>% distinct()

day_level <- merge(day_level, good_list, by= "Dim_Patient", all.x=T)
```

Total number of rows and columns are `r dim(week_level)` and total number of unique patients are `r length(unique(week_level$Dim_Patient))`


Calculate wt gain by taking first entry of the patient and last week prior week 41
```{r}

initial_wt <- day_level %>% group_by(Dim_Patient) %>% 
  filter(week<=40) %>%
  arrange(Dim_Patient, date) %>% filter(row_number()==1 | row_number()==n()) %>%  
  mutate(n = n()) %>%
  filter(n>1) %>%
  arrange(Dim_Patient, date) %>%
  summarise(weight_gain = diff(wt_avg))

initial_wt %>%
  DT::datatable(
    extensions = 'Buttons', 
    options = list(dom = 'Bfrtip', 
                   buttons = c('excel', "csv")))

```


Merge Age, height and calculate BMI
```{r}
ht <- read_excel('GWG(2+)_Corrected.5.10.20(lowcount).xlsx', sheet ='demographics')
names(ht) <- str_replace_all(names(ht), c(" " = "_"))

day_level_demo <- merge(day_level, ht[,c("Dim_Patient", "Activated_At",
                                         "Date_of_Birth", "Age_at_Activation_(years)", 
                                         "Customer_Group", "Height_(m)")],
                        by= "Dim_Patient", all.x = TRUE)


day_level_demo$weight_kg <- day_level_demo$wt_avg/2.2046
```

Calculate BMI 
```{r}
init_wt <-day_level_demo %>% group_by(Dim_Patient) %>% arrange(Dim_Patient,date) %>% filter(row_number() == 1)
  
# initial weight bmi
init_wt$bmi <- init_wt$weight_kg/(init_wt$`Height_(m)`^2)

day_level_demo <- merge(day_level_demo, init_wt[, c("Dim_Patient", "bmi")], by = "Dim_Patient", all.x = T)


day_level_demo$bmi_category <- ifelse(day_level_demo$bmi <18.5, "Underweight", 
                                      ifelse(day_level_demo$bmi<25, "Normal Weight",
                                             ifelse(day_level_demo$bmi<30, "Overweight", 
                                                           "Obese")))

# check patient having ht less than 0.5

lessht <- day_level_demo %>% filter(`Height_(m)`<0.6)
length(unique(lessht))
```

```{r}

# weight gain = T1-T3
weight_gain <- day_level_demo %>% 
  group_by(Dim_Patient)  %>% 
  arrange(Dim_Patient,date) %>% 
  filter((row_number()==1 & trimester== "T1") | (row_number()==n() & trimester== "T3")) %>% 
  mutate(n = n()) %>%
  filter(n>1) %>% arrange(Dim_Patient, trimester) %>%
  summarise(weight_gain = diff(wt_avg))

day_level_demo <- merge(day_level_demo,initial_wt, by= "Dim_Patient", all.x = T)

# create a categorical variable for bmi within and outside recommended range
day_level_demo$bmi_flag <- ifelse(is.na(day_level_demo$weight_gain),NA,
                                  ifelse((day_level_demo$bmi_category=="Underweight") & 
                              (day_level_demo$weight_gain < 40) &  
                                  (day_level_demo$weight_gain > 28), 1,
                              ifelse((day_level_demo$bmi_category=="Normal Weight") &
                                       (day_level_demo$weight_gain > 25) & 
                                           (day_level_demo$weight_gain <35), 1,
                                     ifelse((day_level_demo$bmi_category=="Overweight") &
                                       (day_level_demo$weight_gain > 15) & 
                                           (day_level_demo$weight_gain <25),1,
                                       ifelse((day_level_demo$bmi_category=="Obese") &
                                       (day_level_demo$weight_gain > 11) & 
                                           (day_level_demo$weight_gain <20),1,0)))))

# day_level_demo %>% filter((day_level_demo$bmi_category=="Overweight") &
#                                        (day_level_demo$weight_gain > 15) & 
#                                            (day_level_demo$weight_gain <25) & (Dim_Patient == "ref:Patient/Athena#13122|1966456"))

# calculate wt difference
day_level_demo <- day_level_demo %>% 
  group_by(Dim_Patient)  %>% 
  arrange(Dim_Patient,date) %>%
  mutate(wt_diff = c(0, diff(wt_avg)))

# cross tab
crosstab(day_level_demo, col.vars = "bmi_flag", row.vars = "bmi_category", type = "f")

#write.csv(day_level_demo, "day_level_demo_6_2.csv")
```


Merge week level data
```{r}
week_level_demo <- merge(week_level, ht[,c("Dim_Patient", "Activated_At",
                                         "Date_of_Birth", "Age_at_Activation_(years)", 
                                         "Customer_Group", "Height_(m)")],
                        by= "Dim_Patient", all.x = TRUE)

# weight gain
week_level_demo <- merge(week_level_demo, initial_wt, by= "Dim_Patient", all.x = T)

# BMI
week_level_demo <- merge(week_level_demo, init_wt[, c("Dim_Patient", "bmi")], by = "Dim_Patient", all.x = T)

week_level_demo$bmi_category <- ifelse(week_level_demo$bmi <18.5, "Underweight", 
                                      ifelse(week_level_demo$bmi<25, "Normal Weight",
                                             ifelse(week_level_demo$bmi<30, "Overweight", 
                                                           "Obese")))


# create a categorical variable for bmi within and outside recommended range
week_level_demo$bmi_flag <- ifelse(is.na(week_level_demo$weight_gain),NA,
                                  ifelse((week_level_demo$bmi_category=="Underweight") & 
                              (week_level_demo$weight_gain < 40) &  
                                  (week_level_demo$weight_gain > 28), 1,
                              ifelse((week_level_demo$bmi_category=="Normal Weight") &
                                       (week_level_demo$weight_gain > 25) & 
                                           (week_level_demo$weight_gain <35), 1,
                                     ifelse((week_level_demo$bmi_category=="Overweight") &
                                       (week_level_demo$weight_gain > 15) & 
                                           (week_level_demo$weight_gain <25), 1,
                                       ifelse((week_level_demo$bmi_category=="Obese") &
                                       (week_level_demo$weight_gain > 11) & 
                                           (week_level_demo$weight_gain <20),1,0)))))


# calculate wt difference
week_level_demo <- week_level_demo %>% 
  group_by(Dim_Patient)  %>% 
  arrange(Dim_Patient,week) %>%
  mutate(wt_diff = c(0, diff(wt_avg)))

#week_level_demo %>% filter((week_level_demo$bmi_category=="Obese"))

#write.csv(week_level_demo, "week_level_demo_6_2.csv")

```

## Check the variation in BMI recommend range weight gains outside and within

Class counts - 0 is outside bmi range and 1 is within bmi range
```{r}
sub_week <- week_level_demo %>% 
  filter(!is.na(bmi_flag)) %>% 
  filter(!is.na(bmi_category))

count_sub_week <- sub_week %>% 
  group_by(Dim_Patient, bmi_flag) %>% 
  count()
# check class bias
table(count_sub_week$bmi_flag)

# cross tab
crosstab(sub_week, col.vars = "bmi_flag", row.vars = "bmi_category", type = "f")

```

Before performing t-test we need to verify if the following t-test assumptions are valid:

Assumption1: Are the two samples independents? Yes

Assumption2: Are the data from each of the 2 groups follow a normal distribution? shapiro.test() to compute Shapiro-Wilk test for each group of samples.

```{r}

bmi_out <- count_sub_week %>% filter(bmi_flag==0)
hist(bmi_out$n)
#shapiro.test(bmi_out$n)



bmi_in <- count_sub_week %>% filter(bmi_flag==1)
hist(bmi_in$n)
#shapiro.test(bmi_in$n)
```

Can't perform Shapiro test as sample size is large
//Shapiro test fails, that means data is not normally distributed, but the sample size is large enough (n //> 30), so we can ignore the distribution of the data and use parametric tests.

Assumption3 - have same variance:
```{r}
# Assumption3 - have same variance:
boxplot(n~bmi_flag, data = count_sub_week)
res.ftest <- var.test(n~bmi_flag, data = count_sub_week)
res.ftest

```

The p-value of F-test is p = 0.2127. It’s greater than the significance level alpha = 0.05. In conclusion, there is no significant difference between the variances of the two sets of data. Therefore, we can use the classic t-test which assume equality of the two variances

```{r}

#Wilcoxon  rank-sum  test non parametric test
# t test
ttest<- t.test(n~bmi_flag, data = count_sub_week)
ttest
```

T test shows that the mean of the two samples is not same. 

```{r}

# 2: Are the data from each of the 2 groups follow a normal distribution? shapiro.test() to compute Shapiro-Wilk test for each group of samples.
# 3 Do the two populations have the same variances?  F-test to test for homogeneity in variances. This can be performed with the function var.test() 

# 
# # Run ANOVA
# anova_wt_bmi <- aov(weight_gain~bmi_flag, data = sub_week)
# summary(anova_wt_bmi)

# anova_wt_bmi
```


## Logistic regression

Use number of observations (as a proxy to engagement) to find if recommended weight gain will be within the range or outside

```{r}
logit <- glm(bmi_flag~n, data=count_sub_week, family=binomial(link="logit"))
summary(logit)
```

Frequency distribution of observations 
```{r}
hist(count_sub_week$n)
```

To make the results more interpretable, forming 3 classes of observations - low freq(0-6 weeks), moderate freq (6-15 weeks), high freq (15 onwards). 

```{r}
count_sub_week$obs_categories <- ifelse(count_sub_week$n <5,"Low freq", 
                                        ifelse(count_sub_week$n >=5 & count_sub_week$n <=15,"Moderate freq",
                                               "High freq"))
table(count_sub_week$obs_categories)
table(count_sub_week$bmi_flag)


crosstab(count_sub_week, row.vars = "bmi_flag", col.vars = "obs_categories", type = "f")
```


Now perform logistic regression with the observation classes.
```{r}
logit <- glm(bmi_flag~obs_categories, data=count_sub_week, family=binomial(link="logit"))
summary(logit)
```

having low freq(less engagement), versus high freq(more engagement), changes the log odds of weight gain within the recommended range by -1.37104 similarly it changes by -0.42205 in case of moderate freq

In other words, log of odds ratio to be within bmi range decreases by 1.37 when frequency counts changes from high class to low class.

Odds ratio: 
```{r}
exp(coef(logit))
```

To make the results more interpretable, forming 3 classes of observations - low freq(0-4 weeks), moderate freq (4-10 weeks), high freq (10 onwards). 


## How many total patients by: 
###       - Practice group 
       
```{r}
# By practice group
q1_groups <- day_level_demo %>% select(Customer_Group, Dim_Patient) %>% unique() %>% 
            group_by(Customer_Group) %>% count() %>% arrange(n)

q1_groups$Customer_Group <- factor(q1_groups$Customer_Group, levels = unique(q1_groups$Customer_Group))

q1_groups %>%
  DT::datatable(
    extensions = 'Buttons', 
    options = list(dom = 'Bfrtip', 
                   buttons = c('excel', "csv")))

#plot_ly(q1_groups, y = ~q1_groups$Customer_Group, x = ~q1_groups$n, type = 'bar',  orientation = 'h')

plt1 <- ggplot(q1_groups, aes(x =Customer_Group,  y =n)) + 
  geom_bar(stat = "identity", fill = 'blue') + #theme(axis.text.x = element_text(angle = 90)) +
  theme(axis.title.x=element_blank(), axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) + 
  ggtitle("Total patients across patient groups") +
  ylab("Count of Patients") +
  xlab("Patient groups")

ggplotly(plt1)

```

### Age
```{r}
# Age bracket 
age <- day_level_demo %>% filter((`Age_at_Activation_(years)`>14) &
                                   (`Age_at_Activation_(years)`<60))

length(unique(day_level_demo$Dim_Patient)) - length(unique(age$Dim_Patient))

age$age_category <- ifelse(age$`Age_at_Activation_(years)`<20, "14-19", 
                                      ifelse(age$`Age_at_Activation_(years)`<25, "20-24",
                                             ifelse(age$`Age_at_Activation_(years)`<30, "25-29", 
                                                  ifelse(age$`Age_at_Activation_(years)`<35,"30-34",
                                                        ifelse(age$`Age_at_Activation_(years)`<40,"35-39",
                                                               ifelse(age$`Age_at_Activation_(years)`<45,"40-44",
                                                                      ifelse(age$`Age_at_Activation_(years)`<50,"45-49",
                                                                             ifelse(age$`Age_at_Activation_(years)`<55,"50-54", "55-60"))))))))                          



#age$age_category <- as.numeric(cut(age$`Age_at_Activation_(years)`, 9))
q1_age <- age %>% select(Dim_Patient, age_category) %>% unique() %>% group_by(age_category) %>% count() 


q1_age %>%
  DT::datatable(
    extensions = 'Buttons', 
    options = list(dom = 'Bfrtip', 
                   buttons = c('excel', "csv")))

plt1 <- ggplot(q1_age, aes(x =age_category,  y =n)) + 
  geom_bar(stat = "identity", fill='darkblue') +
  ggtitle("Total patients across different age groups") +
  ylab("Count of Patients") +
  xlab("Age Categories")

ggplotly(plt1)


```


### BMI Categories

```{r}
bmi <- day_level_demo %>% filter((!is.na(bmi_category)) & (`Height_(m)` >0.6))
q1_bmi <- bmi %>% select(Dim_Patient, bmi_category) %>% unique() %>%group_by(bmi_category) %>% count() 

q1_bmi %>%
  DT::datatable(
    extensions = 'Buttons', 
    options = list(dom = 'Bfrtip', 
                   buttons = c('excel', "csv")))

plt1 <- ggplot(q1_bmi, aes(x =bmi_category,  y =n)) + 
  geom_bar(stat = "identity", fill='darkblue') +
  ggtitle("Total patients across different BMI groups") +
  ylab("Count of Patients") +
  xlab("BMI Categories") + scale_x_discrete(limits=c("Underweight", "Normal Weight", "Overweight", "Obese"))

ggplotly(plt1)

```


## How often did each patient enter weights:
        - Entire population 
         - Practice group 
       - Age bracket (5 years)
       - BMI category (less than 25 ; 25.1 - 29.9 ; 30-34.9 ; 35.0-39.9 ; 40-59.9 ; 60 -over)
       
Entire Population
       
```{r}
q2_whole <- day_level_demo %>%
  group_by(Dim_Patient) %>%
  summarize(
    total_obser = n(),
    start_week = min(week),
    start_date = min(date),
    end_date = max(date),
    length = end_date - start_date
  )

q2_whole %>%
  DT::datatable(
    extensions = 'Buttons', 
    options = list(dom = 'Bfrtip', 
                   buttons = c('excel', "csv")))


```


Practice groups 
```{r}

q2_prac <- day_level_demo %>%
  group_by(Customer_Group, Dim_Patient) %>%
  summarise(
    count = n(),
    start_week = min(week),
    start_date = min(date),
    end_date = max(date),
    length = end_date - start_date
  ) %>%
  ungroup() %>%
  group_by(Customer_Group) %>%
  summarise(
    avg_count = mean(count),
    std_count = sd(count),
    mean_week = mean(start_week),
    avg_length = mean(length), 
    unique_patients = n_distinct(Dim_Patient)
  ) 

q2_prac %>%
  DT::datatable(
    extensions = 'Buttons', 
    options = list(dom = 'Bfrtip', 
                   buttons = c('excel', "csv")))
      
```

Age categories 
```{r}
q2_age <- age %>% group_by(age_category, Dim_Patient) %>% 
  summarise(count = n(), start_week = min(week), 
            start_date = min(date), end_date = max(date),  length = end_date - start_date) %>% 
  ungroup() %>% 
  group_by(age_category) %>% 
  summarise(avg_count = mean(count),
            std_count = sd(count), 
            mean_week = mean(start_week), 
            avg_length = mean(length), 
            unique_patients = n_distinct(Dim_Patient)) 

q2_age %>%
  DT::datatable(
    extensions = 'Buttons', 
    options = list(dom = 'Bfrtip', 
                   buttons = c('excel', "csv")))


```


BMI table
```{r}
q2_bmi <- bmi %>% 
  group_by(bmi_category, Dim_Patient) %>% 
  summarise(count = n(), 
            start_week = min(week), 
            start_date = min(date), end_date = max(date), length = end_date - start_date) %>% 
  ungroup() %>% 
  group_by(bmi_category) %>% 
  summarise(avg_count = mean(count),
            std_count = sd(count), 
            mean_week = mean(start_week), 
            avg_length = mean(length), 
            unique_patients = n_distinct(Dim_Patient)) 

q2_bmi %>%
  DT::datatable(
    extensions = 'Buttons', 
    options = list(dom = 'Bfrtip', 
                   buttons = c('excel', "csv")))
```

## What is the average starting time (I.e Gestational age at first entry ) By: 
    --same as previous 

```{r}
# do this for week
q3_whole <- day_level_demo %>% group_by(Dim_Patient) %>% summarise(start_week = min(week)) %>% 
  group_by(start_week)  %>% count()
plt1 <- ggplot(q3_whole, aes(x =start_week,  y =n)) + 
  geom_bar(stat = "identity", fill='darkblue') +
  ggtitle("Start week of all patients") +
  ylab("Count of Patients") +
  xlab("Start week")

ggplotly(plt1)
```

```{r}
q3_prac <- day_level_demo %>% group_by(Customer_Group, Dim_Patient) %>% 
  summarise(start_week = min(week)) %>% ungroup() %>% group_by(Customer_Group) %>%
  summarise(mean_week = mean(start_week))

q3_age <- age %>% group_by(age_category, Dim_Patient) %>% 
  summarise(start_week = min(week)) %>% ungroup() %>% group_by(age_category) %>%
  summarise(mean_week = mean.Date(start_week))

q3_bmi <- bmi %>% group_by(bmi_category, Dim_Patient) %>% 
  summarise(start_week = min(week)) %>% ungroup() %>% group_by(bmi_category) %>%
  summarise(mean_week = mean.Date(start_week))
```

## What is the  length of involvement (i.e difference of gestational age) By: 
    -- same as previous 
    
```{r}
q4_whole <- day_level_demo %>% group_by(Dim_Patient) %>% summarise(start_date = min(date), end_date = max(date),  length = end_date - start_date) 

# q4_whole$length2 = as.numeric(q4_whole$length)
# g1 <- ggplot(q4_whole, aes(x=length2)) +geom_histogram()
# ht1 <- hist(q4_whole$length2)
# ggplotly(g1)

q4_prac <- day_level_demo %>% group_by(Customer_Group, Dim_Patient) %>% 
  summarise(start_date = min(date), end_date = max(date),  length = end_date - start_date) %>% 
  ungroup() %>% group_by(Customer_Group) %>%
  summarise(avg_length = mean(length)) %>% arrange(avg_length)

q4_prac$Customer_Group <- factor(q4_prac$Customer_Group, levels = unique(q4_prac$Customer_Group))

plt1 <- ggplot(q4_prac, aes(x =Customer_Group,  y =avg_length)) + 
  geom_bar(stat = "identity", fill = 'blue') + #theme(axis.text.x = element_text(angle = 90)) +
  theme(axis.title.x=element_blank(), axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) + 
  ggtitle("Total patients across patient groups") +
  ylab("Count of Patients") +
  xlab("Patient groups")

ggplotly(plt1)

q4_age <- age %>% group_by(age_category, Dim_Patient) %>% 
  summarise(start_date = min(date), end_date = max(date),  length = end_date - start_date) %>% 
  ungroup() %>% group_by(age_category) %>%
  summarise(mean_date = mean(length))


q4_bmi <- bmi %>% group_by(bmi_category, Dim_Patient) %>% 
  summarise(start_date = min(date), end_date = max(date),  length = end_date - start_date) %>% 
  ungroup() %>% group_by(bmi_category) %>%
  summarise(mean_date = mean(length))

```

## Weight difference at the start - finish of each trimester by (may be hard for people with only 1 entry per trimester): 
      - Whole group 
      - Practice group
      - Age 
     - BMI group 
     
Whole group
```{r}
q5_whole <- day_level_demo %>% group_by(Dim_Patient, trimester)  %>% 
  arrange(Dim_Patient, date) %>% filter(row_number()==1 | row_number()==n()) %>% 
  mutate(n = n()) %>%
  filter(n>1) %>%
  summarise(weight_diff = diff(wt_avg))

q5_whole %>%
  DT::datatable(
    extensions = 'Buttons', 
    options = list(dom = 'Bfrtip', 
                   buttons = c('excel', "csv")))
```

Practice group 
```{r}

q5_prac <- day_level_demo %>% group_by(Customer_Group, Dim_Patient, trimester)  %>% 
 arrange(Customer_Group, Dim_Patient, date) %>% filter(row_number()==1 | row_number()==n()) %>% 
  mutate(n = n()) %>%
  filter(n>1) %>%
  summarise(weight_diff = diff(wt_avg)) %>% ungroup() %>%
  group_by(Customer_Group, trimester) %>% summarise(avg_weight_diff = mean(weight_diff), 
                                                    std_wt_diff = sd(weight_diff))

q5_prac %>%
  DT::datatable(
    extensions = 'Buttons', 
    options = list(dom = 'Bfrtip', 
                   buttons = c('excel', "csv")))

```


Age
```{r}


q5_age <- age %>% group_by(age_category, Dim_Patient, trimester)  %>% 
 arrange(Dim_Patient, date) %>% filter(row_number()==1 | row_number()==n()) %>% 
  mutate(n = n()) %>%
  filter(n>1) %>%
  summarise(weight_diff = diff(wt_avg)) %>% ungroup() %>%
  group_by(age_category, trimester) %>% summarise(avg_weight_diff = mean(weight_diff), 
                                                    std_wt_diff = sd(weight_diff))
q5_age %>%
  DT::datatable(
    extensions = 'Buttons', 
    options = list(dom = 'Bfrtip', 
                   buttons = c('excel', "csv")))
```


```{r}

q5_bmi <- bmi %>% group_by(bmi_category, Dim_Patient, trimester)  %>% 
 arrange(Dim_Patient, date) %>% filter(row_number()==1 | row_number()==n()) %>% 
  mutate(n = n()) %>%
  filter(n>1) %>%
  summarise(weight_diff = diff(wt_avg), 
            week_diff = diff(week),
            range = ifelse(is.infinite(abs(weight_diff/week_diff)), 1, weight_diff/week_diff)) %>% 
  ungroup() %>%
  group_by(bmi_category, trimester) %>% 
  summarise(avg_weight_diff = mean(weight_diff), 
            std_wt_diff = sd(weight_diff), 
            mean_range = mean(range, na.rm = T))
```

## The rate of weight gain in the second / third trimesters? So average lbs / week ? This would be weight difference in T2  divided by week difference in T2. and then the same for T3 

The values do not reside in the recommended range of the reference table
```{r}
q5_bmi %>%
  DT::datatable(
    extensions = 'Buttons', 
    options = list(dom = 'Bfrtip', 
                   buttons = c('excel', "csv")))
```


Anova in T2 to change if the bmi groups have different means
```{r}
q5 <- bmi %>% filter(trimester %in% c("T2", "T3")) %>%
  group_by(bmi_category, Dim_Patient, trimester)  %>% 
 arrange(Dim_Patient, date) %>% filter(row_number()==1 | row_number()==n()) %>% 
  mutate(n = n()) %>%
  filter(n>1) %>%
  summarise(`Age_at_Activation_(years)` = min(`Age_at_Activation_(years)`),
    weight_diff = diff(wt_avg), 
            week_diff = diff(week),
            rate_of_wtgain = ifelse(is.infinite(abs(weight_diff/week_diff)), 1, weight_diff/week_diff)) %>% filter(!is.na(rate_of_wtgain))

count <- bmi %>%  group_by(Dim_Patient, trimester) %>% count()
  
q5 <- merge(q5, count, by = c("Dim_Patient", "trimester"), all.x = T)
```

Frequency distribution of rate of weight gain in T2 and T3
```{r}
hist(q5$rate_of_wtgain)
```

Perform anova to test if the bmi groups have different means for rate of weight gain

```{r}
tri <- q5 %>% filter(trimester=="T2")
Anova(lm(rate_of_wtgain ~ bmi_category, data=tri))
```
Anova test shows that there is a significat diff within the bmi groups when rate of weight is used as a response variable. The same is observed in case of T3

```{r}
tri <- q5 %>% filter(trimester=="T3")
Anova(lm(rate_of_wtgain ~ bmi_category, data=tri))
```

Following table shows the interaction between bmi category and trimester on the rate of weight gain has  a significant effect. As well as, bmi category and trimester variables have a significant impact on the rate of weight gain.

```{r}
Anova(lm(rate_of_wtgain ~bmi_category*trimester + n, data=q5))
```

Lets build a linear regression model for rate of wt gain as a response variable and bmi category, trimester, age as predictors.
```{r}
model <- lm(rate_of_wtgain ~ bmi_category + trimester + n + `Age_at_Activation_(years)`, data=q5)
summary(model)
```
Model shows that bmi categories, trimester, number of observations and age are statistically significant. The interaction between bmi category and trimester is not significant. 

The R square value shows how much the model explains the variability around the mean in the response variable. In this case, the R sqaure low ~2.9% Hence the model with the variables bmi categories, trimester, number of observations and age does not fit well with the data.


To understand what does it mean when only category is a significant variable and what to do in that case refer: https://www.listendata.com/2016/07/insignificant-levels-of-categorical-variable.html

Coef can be interpreted as, if the bmi group changes from normal weight to over-weight group the rate of wt gain changes by -0.07
Logsitic regression to predict bmi groups within the recommended rate of weight gain:
```{r}
# create a categorical variable for bmi within and outside recommended range
q5$bmi_flag <- ifelse(is.na(q5$rate_of_wtgain),NA,
                                  ifelse((q5$bmi_category=="Underweight") & 
                              (q5$rate_of_wtgain >=1) &  
                                  (q5$rate_of_wtgain <=1.3), 1,
                              ifelse((q5$bmi_category=="Normal Weight") & 
                              (q5$rate_of_wtgain >=0.8) &  
                                  (q5$rate_of_wtgain <=1), 1,
                                     ifelse((q5$bmi_category=="Overweight") & 
                              (q5$rate_of_wtgain >=0.5) &  
                                  (q5$rate_of_wtgain <=0.7), 1,
                                       ifelse((q5$bmi_category=="Obese") & 
                              (q5$rate_of_wtgain >=0.4) &  
                                  (q5$rate_of_wtgain <=0.6), 1,0)))))
table(q5$bmi_flag)
crosstab(q5, row.vars = "bmi_flag", col.vars = "bmi_category", type = "f")
```

```{r}

  
q5$obs_categories <- ifelse(q5$n <=6,"Low freq", 
                                        ifelse(q5$n > 6 & count_sub_week$n <=15,"Moderate freq",
                                               "High freq"))
table(q5$obs_categories)

crosstab(q5, row.vars = "bmi_flag", col.vars = "obs_categories", type = "f")
```

```{r}

Anova(lm(rate_of_wtgain ~ obs_categories, data=q5))
```
Anova between rate of wt gain and observation categories show that all the categories have different mean values. 

Logistic regression between bmi flag and observation categories show that the observation categories are not the significant variables for the classification model (does not have impact when it predict of the classes)

The coef can be intrepreted as a patient low freq(less engagement), versus high freq(more engagement), changes the log odds of rate of weight gain within the recommended range by -0.07 similarly it changes by 0.07 in case of moderate freq. 

```{r}
logit <- glm(bmi_flag~obs_categories, data=q5, family=binomial(link="logit"))
summary(logit)

```



##  weight difference from the first observation to the last observation (IN TRIMESTER 3) 
    by: 
      - same as above 
      
      
```{r}
q6_whole <- q5_whole %>% filter(trimester == "T3")
g1 <- ggplot(q6_whole, aes(x=weight_diff)) + geom_histogram()
ggplotly(g1)

q6_whole %>%
  DT::datatable(
    extensions = 'Buttons', 
    options = list(dom = 'Bfrtip', 
                   buttons = c('excel', "csv")))
```


Practice groups
```{r}

q6_prac <- q5_prac %>% filter(trimester == "T3")
q6_prac %>%
  DT::datatable(
    extensions = 'Buttons', 
    options = list(dom = 'Bfrtip', 
                   buttons = c('excel', "csv")))
```


Age
```{r}
q6_age <- q5_age %>% filter(trimester == "T3")
q6_age %>%
  DT::datatable(
    extensions = 'Buttons', 
    options = list(dom = 'Bfrtip', 
                   buttons = c('excel', "csv")))
```

BMI
```{r}
q6_bmi <- q5_bmi %>% filter(trimester == "T3")
q6_bmi %>%
  DT::datatable(
    extensions = 'Buttons', 
    options = list(dom = 'Bfrtip', 
                   buttons = c('excel', "csv")))
```

## Weight difference from last entry in T3 to last entry in PP by: 
     - same as above 
     
     
Whole population
```{r}

q7_whole <- day_level_demo %>% filter(trimester %in% c("T3", "PP")) %>% 
  group_by(Dim_Patient, trimester)  %>% 
  arrange(Dim_Patient,date) %>% 
  filter(row_number()==n()) %>% ungroup() %>%  
  group_by(Dim_Patient) %>%
  mutate(n = n()) %>%
  filter(n>1) %>%
  summarise(weight_diff = diff(wt_avg))

g1 <- ggplot(q7_whole, aes(x=weight_diff)) + geom_histogram()
ggplotly(g1)

q7_whole %>%
  DT::datatable(
    extensions = 'Buttons', 
    options = list(dom = 'Bfrtip', 
                   buttons = c('excel', "csv")))
```

Practice groups
```{r}

q7_prac <- day_level_demo %>% filter(trimester %in% c("T3", "PP")) %>% 
  group_by(Customer_Group, Dim_Patient, trimester)  %>% 
  arrange(Dim_Patient,date) %>% 
  filter(row_number()==n()) %>% ungroup() %>%  
  group_by(Dim_Patient) %>%
  mutate(n = n()) %>%
  filter(n>1) %>%
  mutate(weight_diff = diff(wt_avg)) %>% filter(row_number()==n()) %>% ungroup() %>%
  group_by(Customer_Group) %>%
  summarise(pt_count = n_distinct(Dim_Patient), avg_weight_diff = mean(weight_diff),
            std_wt_diff = sd(weight_diff))

g1 <- ggplot(q7_prac, aes(x=avg_weight_diff)) + geom_histogram()
ggplotly(g1)

q7_prac %>%
  DT::datatable(
    extensions = 'Buttons', 
    options = list(dom = 'Bfrtip', 
                   buttons = c('excel', "csv")))
```


Age 
```{r}

q7_age <- age %>% filter(trimester %in% c("T3", "PP")) %>% 
  group_by(age_category, Dim_Patient, trimester)  %>% 
  arrange(Dim_Patient,date) %>% 
  filter(row_number()==n()) %>% ungroup() %>%  
  group_by(Dim_Patient) %>%
  mutate(n = n()) %>%
  filter(n>1) %>%
  mutate(weight_diff = diff(wt_avg)) %>% filter(row_number()==n()) %>% ungroup() %>%
  group_by(age_category) %>%
  summarise(pt_count = n_distinct(Dim_Patient), avg_weight_diff = mean(weight_diff),
            std_wt_diff = sd(weight_diff))

q7_age %>%
  DT::datatable(
    extensions = 'Buttons', 
    options = list(dom = 'Bfrtip', 
                   buttons = c('excel', "csv")))
```

BMI 
```{r}
q7_bmi <- bmi %>% filter(trimester %in% c("T3", "PP")) %>% 
  group_by(Dim_Patient, trimester)  %>% 
  arrange(Dim_Patient,date) %>% 
  filter(row_number()==n()) %>% ungroup() %>%  
  group_by(Dim_Patient) %>%
  mutate(n = n()) %>%
  filter(n>1) %>%
  mutate(weight_diff = diff(wt_avg)) %>% filter(row_number()==n()) %>% ungroup() %>%
  group_by(bmi_category) %>%
  summarise(pt_count = n_distinct(Dim_Patient), avg_weight_diff = mean(weight_diff),
            std_wt_diff = sd(weight_diff))

q7_bmi %>%
  DT::datatable(
    extensions = 'Buttons', 
    options = list(dom = 'Bfrtip', 
                   buttons = c('excel', "csv")))
```


## Check if weights difference are statistically significant

Null hypothesis is that the mean of the weight differences is same for all groups 

```{r}

age <- age %>% group_by(Dim_Patient) %>% arrange(Dim_Patient, date) %>%
  mutate(weight_diff = c(0,diff(wt_avg)))

# Run ANOVA
anova_wt_age <- aov(weight_diff ~ age_category, data = age)
summary(anova_wt_age)
anova_wt_age
```

As the p value is low we reject the null hypothesis, which represents the groups are different from each other. Further we us tukeyhsd to check which groups are statistically different from each other

```{r}

tukey_age <- TukeyHSD(anova_wt_age, conf.level = 0.95)
tukey_age
```

age group 14-19 and 20-24 are statiscally different from other groups


Similarlly test differences in bmi categories:

```{r}
bmi <- bmi %>% group_by(Dim_Patient) %>% arrange(Dim_Patient, date) %>%
  mutate(weight_diff = c(0,diff(wt_avg)))
# Run ANOVA
anova_wt_bmi <- aov(weight_diff ~ bmi_category, data = bmi)
summary(anova_wt_bmi)
anova_wt_bmi

```

```{r}
# Run ANOVA
tukey <- TukeyHSD(anova_wt_bmi, conf.level = 0.95)
tukey

```
Apart from overweight and normal weight, all groups are statistically different. 


## Can we get a rate of weight gain (T3-T1) for each group ; and rate of weight loss for PP (PP-T3) 
      - Perhaps here we can interpolate for PP (only 6 weeks)???? 
      
Weight Gain:      
```{r}
wt_gain <- day_level_demo %>% filter(trimester %in% c("T1", "T3")) %>% 
  group_by(Customer_Group, Dim_Patient, trimester)  %>% 
  arrange(Dim_Patient,date) %>% 
  filter( (row_number()==1 & trimester== "T1") | (row_number()==n() & trimester== "T3")) %>% 
  ungroup() %>%  
  group_by(Customer_Group, bmi_category, Dim_Patient) %>%
  mutate(n = n()) %>%
  filter(n>1) %>% arrange(Customer_Group, Dim_Patient, trimester) %>%
  summarise(weight_gain = diff(wt_avg))

wt_gain_groups <- wt_gain %>% group_by(Customer_Group) %>% summarise(avg_gain = mean(weight_gain))


wt_gain_groups %>%
  DT::datatable(
    extensions = 'Buttons', 
    options = list(dom = 'Bfrtip', 
                   buttons = c('excel', "csv")))
wt_gain = merge(wt_gain, good_list, by = "Dim_Patient", all.x = T)

```

## We want to know the behavior of outliers (i.e women who gained MORE or LESS than the goodommended weight gain based on BMI)  This would be T1 - T3 (so over the whole pregnancy)
 - For underweight MORE than 40 or LESS than 28
 - Normal weight more than 35 ; less than  25 
- Overweight   more than 25 ; less than 15
- Obese more than 20 ; less than 1

```{r}
matrix_2by2 <- function(bmi_cat, lr, ur) {
  # over BMi, good engagement
  og <- wt_gain %>% filter((bmi_category==bmi_cat) & 
                              (engagement == "good") & 
                              ( weight_gain > ur | weight_gain < lr)) %>% select(Dim_Patient) %>% distinct()
  
  # within BMi, good engagement
  wg <- wt_gain %>% filter((bmi_category==bmi_cat) & 
                              (engagement == "good") & 
                              (weight_gain <=ur | weight_gain>= lr)) %>% select(Dim_Patient) %>% distinct()
  
  # over BMi, bad engagement
  ob <- wt_gain %>% filter((bmi_category==bmi_cat) & 
                              (engagement == "bad") & 
                              ( weight_gain > ur | weight_gain < lr)) %>% select(Dim_Patient) %>% distinct()
  
  # within BMi, bad engagement
  wb <- wt_gain %>% filter((bmi_category==bmi_cat) & 
                              (engagement == "bad") & 
                             (weight_gain <= ur | weight_gain>= lr)) %>% select(Dim_Patient) %>% distinct()
  
  
  MI <- matrix(c(dim(ob)[1], dim(wb)[1],  dim(og)[1], dim(wg)[1]), nrow = 2)
  
  dimnames(MI) <- list("BMI" = c("bmi_over","bmi_within"), "Engagemnt" = c("bad", "good"))
  MI
  return(MI)
}
```

BMI underweight 
```{r}
MI <- matrix_2by2("Underweight", 28, 40)
MI

# proportion table
prop.out <- prop.table(MI, margin = 1)

#the null hypothesis that the proportions in both groups are the same. In addition it will provide a confidence interval for the difference in proportions.
p.out <-prop.test(MI)

print("difference in proportions")
p.out$estimate[1] - p.out$estimate[2]


 print("For patients outside recommended range of BMi, we expect to observe 7 patients with bad engagement for every 55 patients with good engagement ")
 
MASS::fractions(prop.out[1,1]/prop.out[1,2])

print("Likewise in the within recommended range og BMI group, we expect to observe 2 patients with bad engagement for every 23 patients with good engagement")

MASS::fractions(prop.out[2,1]/prop.out[2,2])


# Percent increase = (Risk Ratio lower bound – 1) x 100
# Percent decrease = (1 – Risk Ratio upper bound) x 100
# Take odds ratio
or.out <- oddsratio(MI, rev="b")
or.out$measure
```
Odds of bad engagement are at least 47% higher for the outside goodommended weight gain group. 


BMI normal weight 
```{r}
MI <- matrix_2by2("Normal Weight", 25, 35)
MI

# proportion table
prop.out <- prop.table(MI, margin = 1)

#the null hypothesis that the proportions in both groups are the same. In addition it will provide a confidence interval for the difference in proportions.
p.out <-prop.test(MI)
p.out

print("difference in proportions")
p.out$estimate[1] - p.out$estimate[2]


 print("For patients outside recommended range of BMi, we expect to observe 121 patients with bad engagement for every 1637 patients with good engagement ")
 
MASS::fractions(prop.out[1,1]/prop.out[1,2])

print("Likewise in the within recommended range of BMI group, we expect to observe 90 patients with bad engagement for every 1267 patients with good engagement")

MASS::fractions(prop.out[2,1]/prop.out[2,2])


# Percent increase = (Risk Ratio lower bound – 1) x 100
# Percent decrease = (1 – Risk Ratio upper bound) x 100
# Take odds ratio
or.out <- oddsratio(MI, rev="b")
or.out$measure
```
Odds of bad engagement are at least 81% higher for the outside goodommended weight gain group. 


BMI over weight 
```{r}
MI <- matrix_2by2("Overweight", 15, 25)
MI

# proportion table
prop.out <- prop.table(MI, margin = 1)

#the null hypothesis that the proportions in both groups are the same. In addition it will provide a confidence interval for the difference in proportions.
p.out <-prop.test(MI)
p.out

print("difference in proportions")
p.out$estimate[1] - p.out$estimate[2]

 
MASS::fractions(prop.out[1,1]/prop.out[1,2])


MASS::fractions(prop.out[2,1]/prop.out[2,2])


# Percent increase = (Risk Ratio lower bound – 1) x 100
# Percent decrease = (1 – Risk Ratio upper bound) x 100
# Take odds ratio
or.out <- oddsratio(MI, rev="b")
or.out$measure
```
Odds of bad engagement are at least 81% higher for the outside goodommended weight gain group. 

BMI Obese
```{r}
MI <- matrix_2by2("Obese", 11, 20)
MI

# proportion table
prop.out <- prop.table(MI, margin = 1)

#the null hypothesis that the proportions in both groups are the same. In addition it will provide a confidence interval for the difference in proportions.
p.out <-prop.test(MI)
p.out

print("difference in proportions")
p.out$estimate[1] - p.out$estimate[2]

 
MASS::fractions(prop.out[1,1]/prop.out[1,2])


MASS::fractions(prop.out[2,1]/prop.out[2,2])


# Percent increase = (Risk Ratio lower bound – 1) x 100
# Percent decrease = (1 – Risk Ratio upper bound) x 100
# Take odds ratio
or.out <- oddsratio(MI, rev="b")
or.out$measure
```





Weight loss:
```{r}

wt_loss <- day_level_demo %>% filter(trimester %in% c("T3", "PP")) %>% 
  group_by(Customer_Group, Dim_Patient, trimester)  %>% 
  arrange(Dim_Patient,date) %>% 
  filter( (row_number()==n() & trimester== "T3") | (row_number()==n() & trimester== "PP")) %>% 
  ungroup() %>%  
  group_by(Customer_Group, Dim_Patient) %>%
  mutate(n = n()) %>%
  filter(n>1) %>% arrange(Customer_Group, Dim_Patient, desc(trimester)) %>%
  summarise(weight_loss = diff(wt_avg))

wt_loss_groups <- wt_loss %>% group_by(Customer_Group) %>% summarise(avg_loss = mean(weight_loss))

wt_loss_groups %>%
  DT::datatable(
    extensions = 'Buttons', 
    options = list(dom = 'Bfrtip', 
                   buttons = c('excel', "csv")))
```
      

Age categories weight gain     
```{r}
age_wt_gain <- age %>% filter(trimester %in% c("T1", "T3")) %>% 
  group_by(age_category, Dim_Patient, trimester)  %>% 
  arrange(Dim_Patient,date) %>% 
  filter( (row_number()==1 & trimester== "T1") | (row_number()==n() & trimester== "T3")) %>% 
  ungroup() %>%  
  group_by(age_category, Dim_Patient) %>%
  mutate(n = n()) %>%
  filter(n>1) %>% 
  arrange(age_category, Dim_Patient, trimester) %>%
  summarise(weight_gain = diff(wt_avg)) %>% 
  group_by(age_category) %>% 
  summarise(avg_weight_gain = mean(weight_gain))

age_wt_gain %>%
  DT::datatable(
    extensions = 'Buttons', 
    options = list(dom = 'Bfrtip', 
                   buttons = c('excel', "csv")))

```


Age wt loss
```{r}
age_wt_loss <- age %>% filter(trimester %in% c("T3", "PP")) %>% 
  group_by(age_category, Dim_Patient, trimester)  %>% 
  arrange(Dim_Patient,date) %>% 
  filter( (row_number()==n() & trimester== "T3") | (row_number()==n() & trimester== "PP")) %>% 
  ungroup() %>%  
  group_by(age_category, Dim_Patient) %>%
  mutate(n = n()) %>%
  filter(n>1) %>% arrange(age_category, Dim_Patient, desc(trimester)) %>%
  summarise(weight_loss = diff(wt_avg)) %>%
  group_by(age_category) %>% 
  summarise(avg_weight_ = mean(weight_loss))


age_wt_loss %>%
  DT::datatable(
    extensions = 'Buttons', 
    options = list(dom = 'Bfrtip', 
                   buttons = c('excel', "csv")))
```

BMI Cateogries

Wt gain
```{r}
bmi_wt_gain <- bmi %>% filter(trimester %in% c("T1", "T3")) %>% 
  group_by(bmi_category, Dim_Patient, trimester)  %>% 
  arrange(Dim_Patient,date) %>% 
  filter( (row_number()==1 & trimester== "T1") | (row_number()==n() & trimester== "T3")) %>% 
  ungroup() %>%  
  group_by(bmi_category, Dim_Patient) %>%
  mutate(n = n()) %>%
  filter(n>1) %>% 
  arrange(bmi_category, Dim_Patient, trimester) %>%
  summarise(weight_gain = diff(wt_avg)* (-1)) %>% 
  group_by(bmi_category) %>% 
  summarise(avg_weight_gain = mean(weight_gain), std_wt_gain = sd(weight_gain))

bmi_wt_gain %>%
  DT::datatable(
    extensions = 'Buttons', 
    options = list(dom = 'Bfrtip', 
                   buttons = c('excel', "csv")))

```


```{r}


```

BMI wt loss
```{r}
bmi_wt_loss <- bmi %>% filter(trimester %in% c("T3", "PP")) %>% 
  group_by(bmi_category, Dim_Patient, trimester)  %>% 
  arrange(Dim_Patient,date) %>% 
  filter( (row_number()==n() & trimester== "T3") | (row_number()==n() & trimester== "PP")) %>% 
  ungroup() %>%  
  group_by(bmi_category, Dim_Patient) %>%
  mutate(n = n()) %>%
  filter(n>1) %>% arrange(bmi_category, Dim_Patient, desc(trimester)) %>%
  summarise(weight_loss = diff(wt_avg)) %>%
  group_by(bmi_category) %>% 
  summarise(avg_weight_ = mean(weight_loss))



bmi_wt_loss %>%
  DT::datatable(
    extensions = 'Buttons', 
    options = list(dom = 'Bfrtip', 
                   buttons = c('excel', "csv")))

```






## Linear regression: check if weight changes with the age or bmi

BMI and wt change is not correlated
```{r}
bmi <- bmi %>% group_by(Dim_Patient) %>% arrange(Dim_Patient, date) %>%
  mutate(weight_diff = c(0,diff(wt_avg)))

cor(bmi$bmi, bmi$weight_diff)

ggplot(bmi, aes(x=bmi, y=weight_diff)) + 
  geom_point()+
  geom_smooth(method=lm)

```


Age and wt is not correlated
```{r}

age <- age %>% group_by(Dim_Patient) %>% arrange(Dim_Patient, date) %>%
  mutate(weight_diff = c(0,diff(wt_avg)))


cor(age$`Age_at_Activation_(years)`, age$weight_diff)

ggplot(age, aes(x=`Age_at_Activation_(years)`, y=wt_avg)) + 
  geom_point()+
  geom_smooth(method=lm)

```



