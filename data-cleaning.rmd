---
title: "Patient data analysis"
author: "Tanaya Kavathekar"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: hide
    fig_height: 4.5
    fig_width: 7
    highlight: tango
    number_sections: yes
    theme: cosmo
    toc: yes
    toc_float: true
  pdf_document:
    toc: yes
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(error = F)
#knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(include = T)
knitr::opts_chunk$set(warning = F)
```

```{r basicfcn, include=F}
# can add quietly=T option to the require() function
loadPkg = function(x) { if (!require(x,character.only=T, quietly =T)) { install.packages(x,dep=T,repos="http://cran.us.r-project.org"); if(!require(x,character.only=T)) stop("Package not found") } }


# Create the function.
getmode <- function(v) {
   uniqv <- unique(v)
   uniqv[which.max(tabulate(match(v, uniqv)))]
}

```

```{r, include=F}
loadPkg("readxl")
loadPkg("plyr")
loadPkg("dplyr")
loadPkg("stringr")
loadPkg("tidyverse")
loadPkg("ggplot2")
loadPkg("plotly")
loadPkg("lubridate")

```

Reading data ..
```{r}
raw_df <- read_excel('GWG(2+)_Corrected.5.10.20(lowcount).xlsx',sheet='master')
names(raw_df) <- str_replace_all(names(raw_df), c(" " = "_"))

test_pt <- read_excel('test_patients_exclude.xlsx')
names(test_pt) <- str_replace_all(names(test_pt), c(" " = "_"))
length(unique(test_pt$Dim_Patient))

# if space in the column name change to underscore


dim(raw_df)
length(unique(raw_df$Dim_Patient))
```

Removing test patients 
```{r}

raw_df <- anti_join(raw_df, test_pt)
length(unique(raw_df$Dim_Patient))
```

Total number of rows and columns are `r dim(raw_df)` and total number of unique patients are `r length(unique(raw_df$Dim_Patient))`


Drop null values from the data - 
```{r}
df <- raw_df %>% drop_na(Dim_Patient)
df <- df %>% filter(Dim_Patient !=0)
dim(df)
length(unique(df$Dim_Patient))
```

Remove duplicate rows:
```{r}
df$date <- as.Date(df$Observed_At)

# remove diff column as it will be recalculated again
df <-subset(df,select = - c(Weight_Difference, Days_Since_Last_Entry, Observed_At,Trimester))

# drop duplicates
df <- unique(df)
```


Low count 1
```{r}
# merge corrected low count df
low_count <- read_excel('original_df.xlsx')
low_count$date <- as.Date(low_count$Observed_At)
low_count <-subset(low_count,select = - c(Observed_At, Trimester))

df_low_count_rm <- df %>% filter(!Dim_Patient %in% low_count$Dim_Patient)

df <- rbind(df_low_count_rm, low_count)
```


Low count 2 updated
```{r}
low_count2 <- read_excel('original_df2_updated.xlsx')

df_low_count_rm2 <- df %>% filter(!Dim_Patient %in% low_count2$Dim_Patient)

df <- rbind(df_low_count_rm, low_count)
```


```{r}
# GTA column has missing values 
sum(is.na(df))
# filter rows having GTA as null
gat_null <- df %>% filter(is.na(EDD))

# time being drop those columns 
df <-df %>% drop_na(EDD)

length(unique(raw_df$Dim_Patient)) - length(unique(df$Dim_Patient))
length(unique(df$Dim_Patient))
```


Keep only those patients who have observation value > 80
```{r }
df <- df %>% filter((Observation_Value > 80) & (Observation_Value < 380))
length(unique(df$Dim_Patient))
```

Keep only 47 weeks of data from observe date
```{r}
df$EDD  <- as.Date(df$EDD)
# add week and day column
df <- df %>% 
  mutate(week = trunc((279-as.numeric(EDD) + as.numeric(date))/7), 
         days = (279-as.numeric(EDD) + as.numeric(date))%%7, 
         trimester = ifelse(trunc((279-as.numeric(EDD) + as.numeric(date))/7)< 13,"T1",
                                                          ifelse(trunc((279-as.numeric(EDD) + 
                                                                          as.numeric(date))/7)< 27, "T2",
                                                                  ifelse(trunc((279-as.numeric(EDD) 
                                                                                + as.numeric(date))/7)<41,"T3","PP"))))

df <- df %>% filter((week>=0) &(week<=47))

length(unique(df$Dim_Patient))
```

Remove patients having only 3 or less observations and only one trimester data 
```{r}
# get only trimester values at patient-trimester level
dpt <- df %>% select(Dim_Patient, trimester) %>% distinct(Dim_Patient, trimester)

# check how many patients have length
agg <- aggregate(data=dpt, trimester ~ Dim_Patient, function(x) length(unique(x)))

less_data <- agg %>% filter(trimester == 1)

length(unique(less_data$Dim_Patient))

check2 <- merge(
  df, less_data, by = "Dim_Patient", all.y=T)


check2_2 <- check2 %>% group_by(Dim_Patient) %>% count()

# remove these patients 
ct2 <- check2_2 %>% filter(n<4)
length(unique(ct2$Dim_Patient))

df <- subset(df, !df$Dim_Patient %in% ct2$Dim_Patient)
length(unique(df$Dim_Patient))

# save data of removed patients 
```

Remove entries if less than 2 observations within a day
```{r}
intermediate_rollup <- df %>% group_by(Dim_Patient, date) %>% summarise(mean = mean(Observation_Value))
#view(intermediate_rollup %>% group_by(Dim_Patient)  %>% count() %>% filter(n < 3))
# remove entries if less than 2

count <- intermediate_rollup %>% group_by(Dim_Patient)  %>% count() %>% filter(n > 2)

df <- merge(df, count[,"Dim_Patient"], by = "Dim_Patient")
length(unique(df$Dim_Patient))
```

Calculate trimester and days since column
```{r}
df <- df %>% group_by(Dim_Patient) %>% 
  arrange(Dim_Patient, date) %>%
  mutate(days_since = c(0,diff(date)))
```



Keep the manually cleaned data
```{r}
man_cl1 <- read_xlsx('low_count.xlsx')
keep1 <- man_cl1 %>% filter((Resolution == "KEEP")| (Resolution == "keep"))

man_cl2 <- read_xlsx('low_count2.xlsx')
keep2 <- man_cl2 %>% filter((Resolution == "KEEP") | (Resolution == "keep"))

manually_rm_out <- df %>% filter((Dim_Patient %in% keep1$Dim_Patient) | (Dim_Patient %in% keep2$Dim_Patient))


length(unique(manually_rm_out$Dim_Patient))
```

Day level check if value greater than 5
```{r}
#p2 <- df %>% filter(Dim_Patient == "ref:Patient/BabyscriptsLegacy#5387")

out_rm <- df %>% filter(!(Dim_Patient %in% manually_rm_out$Dim_Patient))

# count initial values
count_rows <- out_rm %>% group_by(Dim_Patient, date) %>%  
  summarise(wt = mean(Observation_Value)) %>% ungroup() %>%  
  group_by(Dim_Patient) %>% summarise(initial_count = n())

daily <- out_rm %>% group_by(Dim_Patient, date) %>% arrange(Dim_Patient, date) %>%
  mutate(weight_diff = c(0,diff(Observation_Value)), 
         wt_flg =  ifelse((abs(weight_diff) >= 5) & (trimester != "PP"), NA, Observation_Value))  %>% ungroup() %>% filter(!is.na(wt_flg))


weekly <- daily %>% group_by(Dim_Patient, trimester) %>% arrange(Dim_Patient, date) %>%
  mutate(weight_diff_tri = c(0,diff(Observation_Value)), 
         mode_wt_tri = getmode(Observation_Value),
         diff = Observation_Value - mode_wt_tri,
         wt_flg_tri =  ifelse((days_since <= 70) & (abs(diff) >= 15) & (trimester != "PP"), NA, Observation_Value)) %>%
  filter(!is.na(wt_flg_tri))%>% 
  ungroup() %>% 
  group_by(Dim_Patient) %>% 
  mutate(mode = getmode(Observation_Value), mode_dev =  ifelse((abs(Observation_Value - mode) >= 40), NA, Observation_Value)) %>% 
  filter(!is.na(mode_dev))


complete <- weekly %>% group_by(Dim_Patient, trimester) %>% 
  mutate( avg = mean(Observation_Value)) %>% 
  ungroup() %>% 
  group_by(Dim_Patient) %>% 
  mutate(diff_avg =ifelse((abs(Observation_Value - avg[1]) >= 20) & (trimester == "PP"), NA, Observation_Value)) %>% 
  filter(!is.na(diff_avg))

# calculate filtered counts
count_2 <- complete %>% group_by(Dim_Patient, date) %>%  
  summarise(wt = mean(Observation_Value)) %>% ungroup() %>%  
  group_by(Dim_Patient) %>% summarise(after_count = n())

count_rows <- merge(count_rows, count_2, by = "Dim_Patient") 

count_rows <- count_rows %>% mutate(per_removed = ((initial_count - after_count)/initial_count) * 100)
```


Remove low count and add manually filtered data back to the cleaned df
```{r}
low <- count_rows %>% filter(per_removed  > 50)

cleaned_df <- complete %>% filter(!(Dim_Patient %in% low$Dim_Patient)) %>% 
  select(Dim_Patient, Observation_Source, Observation_Value, EDD, GA_at_Observation, date, week, trimester, days_since)


processed_df <- rbind(cleaned_df, manually_rm_out)
```


Roll up the data at a day level and remove observations less than 2
```{r}
day_level<- processed_df %>% group_by(Dim_Patient, trimester, Observation_Source, date, week, days) %>% summarise(wt_avg = mean(Observation_Value))

lessthan_2 <- day_level %>% group_by(Dim_Patient) %>% count() %>% filter(n < 3)

day_level <- day_level %>% filter(!Dim_Patient %in% lessthan_2$Dim_Patient)
```


Check first and last week difference in weights
```{r}

initial_wt <- day_level %>% group_by(Dim_Patient) %>% 
  arrange(Dim_Patient, date) %>% filter(row_number()==1 | row_number()==n()) %>%  arrange(Dim_Patient, date) %>% mutate(weight_diff_tri = c(0,diff(wt_avg)), week_diff = c(0,diff(week)))

```


Merge Age, height and calculate BMI
```{r}


```



## What is the change in weight during pregnancy for our entire population (Initial entry to 40weeks gestation) 
```{r}
q1 <-  out %>% group_by(week) %>% summarise(total_weight = sum(Observation_Value)) %>% arrange(week) %>% mutate(change = (c(total_weight[1], diff(total_weight)))/total_weight[1])

plot1 <- ggplot(data=q1, aes(x=week, y=change)) +
  geom_line()+
  geom_point() +
  ggtitle("Change in weight for all patients") 
  


ggplotly(plot1)
```


```{r}

# BMI between 15 and 65


# after removing less than 100 observ value, set first date as initial, calculate BMI  
# remove patients with height less than 1m 


# remove if weeks less than 2, 

check1 <- df %>% group_by(Dim_Patient, Trimester, week) %>% count()

view(df %>% filter(Dim_Patient == "ref:Patient/Redox#wellspan.org|007164527"))

#df$initial_weight <- ifelse(df$Days_Since_Last_Entry == FALSE, df$Observation_Value, 0)



```

## What is the change in weight for specific population groups (By customer group, by BMI category, by age) 


```{r}
# get only trimester values at patient-trimester level
dpt <- df %>% select(Dim_Patient, Trimester) %>% distinct(Dim_Patient, Trimester)
# check how many patients have length
agg <- aggregate(data=dpt, Trimester ~ Dim_Patient, function(x) length(unique(x)))
```

```{r}


# customers having full trimester data
df_tri <- agg %>% filter(Trimester == 3) %>% select(Dim_Patient)

#print(" Unique Patients having 3 trimester data", length(unique(df_tri$Dim_Patient)))

# filter to get entire dataset of these patients
sub_df <- merge(df_new, df_tri, by = "Dim_Patient", all.y = TRUE)
length(unique(sub_df$Dim_Patient))


# check week values for trimester patient data 
check <- sub_df %>% group_by(Dim_Patient) %>% summarise(min = min(week), max = max(week), count = n())


```




